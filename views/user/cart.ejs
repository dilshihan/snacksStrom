<!DOCTYPE html>
<html>
  <head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta
      name="viewport"content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="/images/favicon.png" type="" />
    <title>SNACK STORM - Cart</title>
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css" />
    <link rel="stylesheet"type="text/css"href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"/>
    <link rel="stylesheet"href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css" integrity="sha512-CruCP+TD3yXzlvvijET8wV5WxxEh5H8P4cmz0RFbKK6FlZ2sYl3AEsKlLPHbniXKSrDdFewhbmBK5skbdsASbQ=="crossorigin="anonymous"/>
    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/responsive.css" />
    <link href="/css/font-awesome.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/style/cart.css" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="sub_page">
    <header class="header_section">
      <div class="container">
        <nav class="navbar navbar-expand-lg custom_nav-container">
          <a class="navbar-brand" href="/user/home">
            <span> SNACK STORM </span>
          </a>

          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class=""> </span>
          </button>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mx-auto">
              <li class="nav-item">
                <a class="nav-link" href="/user/home">Home </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/menu">Menu </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/about">About</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/contactus">Contact Us</a>
              </li>
            </ul>
            <div class="user_option">
              <a class="cart_link" href="/user/cart">
                <span class="sr-only">(current)</span>
                <svg
                  version="1.1"
                  id="Capa_1"
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink"
                  x="0px"
                  y="0px"
                  viewBox="0 0 456.029 456.029"
                  style="enable-background: new 0 0 456.029 456.029"
                  xml:space="preserve"
                >
                  <g>
                    <g>
                      <path
                        d="M345.6,338.862c-29.184,0-53.248,23.552-53.248,53.248c0,29.184,23.552,53.248,53.248,53.248
                     c29.184,0,53.248-23.552,53.248-53.248C398.336,362.926,374.784,338.862,345.6,338.862z"
                      />
                    </g>
                  </g>
                  <g>
                    <g>
                      <path
                        d="M439.296,84.91c-1.024,0-2.56-0.512-4.096-0.512H112.64l-5.12-34.304C104.448,27.566,84.992,10.67,61.952,10.67H20.48
                     C9.216,10.67,0,19.886,0,31.15c0,11.264,9.216,20.48,20.48,20.48h41.472c2.56,0,4.608,2.048,5.12,4.608l31.744,216.064
                     c4.096,27.136,27.648,47.616,55.296,47.616h212.992c26.624,0,49.664-18.944,55.296-45.056l33.28-166.4
                     C457.728,97.71,450.56,86.958,439.296,84.91z"
                      />
                    </g>
                  </g>
                  <g>
                    <g>
                      <path
                        d="M215.04,389.55c-1.024-28.16-24.576-50.688-52.736-50.688c-29.696,1.536-52.224,26.112-51.2,55.296
                     c1.024,28.16,24.064,50.688,52.224,50.688h1.024C193.536,443.31,216.576,418.734,215.04,389.55z"
                      />
                    </g>
                  </g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                </svg>
              </a>
              <form class="form-inline">
                <button class="btn my-2 my-sm-0 nav_search-btn" type="submit">
                  <i class="fa fa-search" aria-hidden="true"></i>
                </button>
              </form>
              <a href="/user/userprofile" class="user_link">
                <% if (user && user.image) { %>
                  <img src="<%= user.image %>" style="width: 30px; height: 30px; object-fit: cover; border-radius: 50%;" alt="Profile" />
                <% } else { %>
                  <i class="fa fa-user" aria-hidden="true"></i>
                <% } %>
              </a>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <div class="hero_area"></div>

    <!-- cart section -->
    <section class="book_section layout_padding">
      <div class="container">
        <div class="heading_container">
          <h2>Shopping Cart</h2>
          <div class="row">
            <div class="col-md-8">
              <div class="cart_container" style="margin-top: 30px">
                <% if (cart && cart.length > 0) { %> <% cart.forEach((item,
                index) => { %>
                <div class="cart_item">
                  <div class="item_image">
                    <img
                      src="/uploads/<%= item.image[0] %>"
                      alt="<%= item.name %>"
                    />
                  </div>
                  <div class="item_info">
                    <h4><%= item.name %></h4>
                    <p class="price">₹<%= item.price %></p>
                  </div>
                  <div class="cart-item" data-product-id="<%= item.id %>">
                    <div class="quantity_controls">
                      <button
                        class="qty_btn"
                        onclick="updateQuantity('<%= index %>', -1)"
                      >
                        -
                      </button>
                      <input
                        type="number"
                        value="<%= item.quantity %>"
                        min="1"
                        class="qty_input"
                        id="qty_<%= index %>"
                      />
                      <button
                        class="qty_btn"
                        onclick="updateQuantity('<%= index %>', 1)"
                      >
                        +
                      </button>
                    </div>
                  </div>
                  <div class="item_total">
                    ₹<span id="total_<%= index %>"
                      ><%= (item.price * item.quantity).toFixed(2) %></span
                    >
                  </div>
                  <button
                    class="remove_btn"
                    onclick="removefromcart('<%- item.id %>')"
                  >
                    <i class="fa fa-trash"></i>
                  </button>
                </div>
                <% }); %> <% } else { %>
                <p>Your cart is empty. Start shopping!</p>
                <% } %>
              </div>
            </div>
            <div class="col-md-4">
              <div class="cart_summary">
                <h3>Order Summary</h3>
                <% let subtotal = 0; %> <% cart.forEach(item => { subtotal +=
                item.price * item.quantity; }); %> <% let shipping = subtotal >
                0 ? 5.00 : 0; %> <% let tax = subtotal * 0.1; %> <% let
                discount = 0; %> <% let total = subtotal + shipping + tax -
                discount; %>
                <div class="summary_item">
                  <span>Subtotal</span>
                  <span>₹<%= subtotal.toFixed(2) %></span>
                </div>
                <div class="summary_item">
                  <span>Shipping</span>
                  <span>₹<%= shipping.toFixed(2) %></span>
                </div>
                <div class="summary_item">
                  <span>Tax</span>
                  <span>₹<%= tax.toFixed(2) %></span>
                </div>
                <div class="summary_item">
                  <span>Discount</span>
                  <span>-₹<%= discount.toFixed(2) %></span>
                </div>
                <div class="summary_total">
                  <span>Total</span>
                  <span>₹<%= total.toFixed(2) %></span>
                </div>
                <button class="checkout_btn">Proceed to Checkout</button>
                <div class="coupon_container">
                  <h4>Have a Coupon?</h4>
                  <div class="coupon_input_group">
                    <input
                      type="text"
                      id="couponCode"
                      placeholder="Enter your coupon code"
                      class="form-control"
                    />
                    <button class="apply_btn" onclick="applyCoupon()">
                      Apply <i class="fa fa-arrow-right"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>
    <!-- footer section -->
    <footer class="footer_section">
      <div class="container">
        <div class="row">
          <div class="col-md-4 footer-col">
            <div class="footer_contact">
              <h4>Contact Us</h4>
              <div class="contact_link_box">
                <a href="">
                  <i class="fa fa-map-marker" aria-hidden="true"></i>
                  <span> Location </span>
                </a>
                <a href="">
                  <i class="fa fa-phone" aria-hidden="true"></i>
                  <span> Call +91 8089113204 </span>
                </a>
                <a href="">
                  <i class="fa fa-envelope" aria-hidden="true"></i>
                  <span> mohddilshan1234321@gmail.com </span>
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-4 footer-col">
            <div class="footer_detail">
              <a href="" class="footer-logo"> SNACK STORM </a>
              <p>
                Necessary, making this the first true generator on the Internet.
                It uses a dictionary of over 200 Latin words, combined with
              </p>
              <div class="footer_social">
                <a href="">
                  <i class="fa fa-facebook" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-twitter" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-linkedin" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-instagram" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-pinterest" aria-hidden="true"></i>
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-4 footer-col">
            <h4>Opening Hours</h4>
            <p>Everyday</p>
            <p>10.00 Am -10.00 Pm</p>
          </div>
        </div>
        <div class="footer-info">
          <p>
            &copy; <span id="displayYear"></span> All Rights Reserved By
            <a href="">muhammed dilshihan</a><br /><br />
            &copy; <span id="displayYear"></span> Distributed By
            <a href="" target="_blank">dilshihan</a>
          </p>
        </div>
      </div>
    </footer>
    <!-- jQery -->
    <script src="/js/jquery-3.4.1.min.js"></script>
    <!-- popper js -->
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <!-- bootstrap js -->
    <script src="/js/bootstrap.js"></script>
    <!-- owl slider -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <!-- isotope js -->
    <script src="https://unpkg.com/isotope-layout@3.0.4/dist/isotope.pkgd.min.js"></script>
    <!-- nice select -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
    <!-- custom js -->
    <script src="/js/custom.js"></script>
    <!-- Google Map -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh39n5U-4IoWpsVGUHWdqB6puEkhRLdmI&callback=myMap"></script>
    <script>
      let lastScrollTop = 0;
      const header = document.querySelector(".header_section");
      let headerHeight = header.offsetHeight;

      window.addEventListener(
        "scroll",
        function () {
          let currentScroll =
            window.pageYOffset || document.documentElement.scrollTop;

          if (currentScroll > lastScrollTop && currentScroll > headerHeight) {
            // Scrolling down
            header.style.transform = "translateY(-100%)";
          } else {
            // Scrolling up
            header.style.transform = "translateY(0)";
          }
          lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
        },
        false
      );
    </script>
    <script>
      async function fetchCart() {
        try {
          const response = await fetch("/cart");
          const data = await response.json();
          console.log("Fetched Cart Data:", data);
        } catch (error) {
          console.error("Error fetching cart:", error);
        }
      }

      fetchCart();
    </script>
    <script>
      function updateQuantity(index, change) {
    const productId = document.querySelector(`#qty_${index}`).closest('.cart-item').dataset.productId;
    fetch('/user/update-cart-quantity', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            productId: productId,
            change: change
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const qtyInput = document.getElementById(`qty_${index}`);
            qtyInput.value = data.newQuantity;

            const totalPriceElement = document.getElementById('cart-total');
            if (totalPriceElement) {
                totalPriceElement.textContent = `₹${data.totalPrice.toFixed(2)}`;
            }
            window.location.reload();
        } else {
            console.error('Update failed:', data);
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Failed to update cart'
        });
    });
}
      
      async function removefromcart(productId) {
        try {
          const response = await fetch(`cart/remove/${productId}`, {
            method: "DELETE",
          });

          const data = await response.json();

          if (response.ok) {
            Swal.fire({
              icon: "success",
              title: "Removed!",
              text: data.message,
              showConfirmButton: false,
              timer: 1500,
            }).then(() => {
              location.reload();
            });
          } else {
            Swal.fire({
              icon: "error",
              title: "Oops...",
              text: data.message || "Failed to remove item.",
            });
          }
        } catch (error) {
          console.error("Error removing item:", error);
          Swal.fire({
            icon: "error",
            title: "Error!",
            text: "Something went wrong. Please try again.",
          });
        }
      }
    </script>
    <script>
document.querySelector('.checkout_btn').addEventListener('click', () => {
    window.location.href = "/user/checkout";
});
</script>
  </body>
</html>
