<!DOCTYPE html>
<html>
  <head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta
      name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="/images/favicon.png" type="" />
    <title>SNACK STORM - Wishlist</title>
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css" integrity="sha512-CruCP+TD3yXzlvvijET8wV5WxxEh5H8P4cmz0RFbKK6FlZ2sYl3AEsKlLPHbniXKSrDdFewhbmBK5skbdsASbQ==" crossorigin="anonymous"/>
    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/responsive.css" />
    <link href="/css/font-awesome.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="/style/wishlist.css">

  </head>
  <body class="sub_page">
    <header class="header_section">
      <div class="container">
        <nav class="navbar navbar-expand-lg custom_nav-container">
          <a class="navbar-brand" href="/user/home">
            <span> SNACK STORM </span>
          </a>

          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class=""> </span>
          </button>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mx-auto">
              <li class="nav-item">
                <a class="nav-link" href="/user/home">Home </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/menu">Menu </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/about">About</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/contactus">Contact Us</a>
              </li>
            </ul>
            <div class="user_option">
              <a class="cart_link" href="/user/cart" style="position: relative; display: inline-block;">
                <svg
                  version="1.1"
                  id="Capa_1"
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink"
                  x="0px"
                  y="0px"
                  viewBox="0 0 456.029 456.029"
                  style="enable-background: new 0 0 456.029 456.029"
                  xml:space="preserve"
                >
                  <g>
                    <g>
                      <path
                        d="M345.6,338.862c-29.184,0-53.248,23.552-53.248,53.248c0,29.184,23.552,53.248,53.248,53.248
                     c29.184,0,53.248-23.552,53.248-53.248C398.336,362.926,374.784,338.862,345.6,338.862z"
                      />
                    </g>
                  </g>
                  <g>
                    <g>
                      <path
                        d="M439.296,84.91c-1.024,0-2.56-0.512-4.096-0.512H112.64l-5.12-34.304C104.448,27.566,84.992,10.67,61.952,10.67H20.48
                     C9.216,10.67,0,19.886,0,31.15c0,11.264,9.216,20.48,20.48,20.48h41.472c2.56,0,4.608,2.048,5.12,4.608l31.744,216.064
                     c4.096,27.136,27.648,47.616,55.296,47.616h212.992c26.624,0,49.664-18.944,55.296-45.056l33.28-166.4
                     C457.728,97.71,450.56,86.958,439.296,84.91z"
                      />
                    </g>
                  </g>
                  <g>
                    <g>
                      <path
                        d="M215.04,389.55c-1.024-28.16-24.576-50.688-52.736-50.688c-29.696,1.536-52.224,26.112-51.2,55.296
                     c1.024,28.16,24.064,50.688,52.224,50.688h1.024C193.536,443.31,216.576,418.734,215.04,389.55z"
                      />
                    </g>
                  </g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                </svg>
                <% if (cartCount > 0) { %>
                  <span style="position: absolute; top: -10px; right: -10px; background-color: red; color: white; border-radius: 50%; padding: 2px 6px; font-size: 12px;">
                      <%= cartCount %>
                  </span>
              <% } %>
              </a>
              <form class="form-inline">
                <a href="/user/wishlist" class="btn my-2 my-sm-0 nav_wishlist-btn" style="color: white;">
                    <i class="fa fa-heart" aria-hidden="true"></i>
                </a>
              </form>
              <a href="/user/userprofile" class="user_link">
                <% if (user && user.image) { %>
                  <img src="<%= user.image %>" style="width: 30px; height: 30px; object-fit: cover; border-radius: 50%;" alt="Profile" />
                <% } else { %>
                  <i class="fa fa-user" aria-hidden="true"></i>
                <% } %>
              </a>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <div class="hero_area"></div>

    <!-- wishlist section -->
    <section class="wishlist_section layout_padding">
      <div class="container">
          <div class="wishlist_header">
              <h2>My Wishlist</h2>
          </div>
          
          <div class="row">
              <div class="col-12">
                  <div class="wishlist_container">
                      <% if (wishlistItems && wishlistItems.length > 0) { %>
                          <% wishlistItems.forEach(function(item) { %>
                              <div class="wishlist_item" data-product-id="<%= item.productId._id %>">
                                  <div class="item_image position-relative">
                                      <img src="/uploads/<%= item.productId.image[0] %>" alt="<%= item.productId.name %>" />
                                      <% if (item.productId.maxOffer && item.productId.maxOffer > 0) { %>
                                          <div class="offer-badge">
                                              <% if (item.productId.maxOffer >= 50) { %>
                                                  <span class="big-offer">MEGA OFFER</span>
                                              <% } %>
                                              <% if (item.productId.offerType === 'category') { %>
                                                  <span class="offer-type">Category Offer</span>
                                              <% } %>
                                              <%= item.productId.maxOffer %>% OFF
                                          </div>
                                      <% } %>
                                  </div>
                                  <div class="item_info">
                                      <h4><%= item.productId.name %></h4>
                                      <% if (item.productId.maxOffer && item.productId.maxOffer > 0) { %>
                                          <div class="price-info">
                                              <p class="original-price">MRP: <del>₹<%= item.productId.originalPrice.toFixed(2) %></del></p>
                                              <p class="discounted-price">MRP ₹<%= item.productId.discountedPrice.toFixed(2) %></p>
                                          </div>
                                      <% } else { %>
                                          <p class="price">MRP ₹<%= item.productId.price.toFixed(2) %></p>
                                      <% } %>
                                      <% if (item.productId.stock > 0) { %>
                                          <p class="item_availability">In Stock</p>
                                      <% } else { %>
                                          <p class="item_availability out-of-stock">Out of Stock</p>
                                      <% } %>
                                  </div>
                                  <div class="action_buttons">
                                      <% if (item.productId.stock > 0) { %>
                                          <button class="action_btn add_to_cart_btn" 
                                              onclick="addToCartAndRemoveFromWishlist('<%= item.productId._id %>', 1, '<%= item.productId.name %>', '<%= userId %>')">
                                              <i class="fa fa-shopping-cart mr-2"></i> Add to Cart
                                          </button>
                                      <% } else { %>
                                          <button class="action_btn add_to_cart_btn" disabled style="background-color: #ccc;">
                                              <i class="fa fa-shopping-cart mr-2"></i> Add to Cart
                                          </button>
                                      <% } %>
                                      <button class="remove_btn" onclick="removeFromWishlist('<%= item.productId._id %>')">
                                          <i class="fa fa-trash"></i>
                                      </button>
                                  </div>
                              </div>
                          <% }); %>
                          <div class="pagination-container">
                            <% if (pagination.hasPrevPage) { %>
                                <a href="?page=<%= pagination.currentPage - 1 %>" class="pagination-btn"><<</a>
                            <% } %>
                            
                            <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                                <a href="?page=<%= i %>" 
                                   class="pagination-btn <%= pagination.currentPage === i ? 'active' : '' %>">
                                    <%= i %>
                                </a>
                            <% } %>
                            
                            <% if (pagination.hasNextPage) { %>
                                <a href="?page=<%= pagination.currentPage + 1 %>" class="pagination-btn">>></a>
                            <% } %>
                        </div>
                      <% } else { %>
                          <div class="empty_wishlist">
                              <i class="fa fa-heart-o"></i>
                              <h3>Your wishlist is empty</h3>
                              <p>Add items to your wishlist to save them for later!</p>
                              <button class="shop_now_btn" onclick="location.href='/user/menu'">Shop Now</button>
                          </div>
                      <% } %>
                  </div>
              </div>
          </div>
          
          <!-- Recently viewed section -->
          <div class="recently_viewed">
              <h3>You May Also Like</h3>
              <div class="product_slider">
                  <% if (relatedProducts && relatedProducts.length > 0) { %>
                      <% relatedProducts.forEach(function(product) { %>
                          <div class="product_card">
                              <a href="/user/productdetails/<%= product._id %>" class="product_img_link">
                                  <div class="product_img position-relative">
                                      <img src="/uploads/<%= product.image[0] %>" alt="<%= product.name %>" />
                                      <% if (product.maxOffer && product.maxOffer > 0) { %>
                                          <div class="offer-badge-small">
                                              <% if (product.maxOffer >= 50) { %>
                                                  <span class="big-offer-small">MEGA</span>
                                              <% } %>
                                              <%= product.maxOffer %>% OFF
                                          </div>
                                      <% } %>
                                  </div>
                              </a>
                              <div class="product_info">
                                  <a href="/user/productdetails/<%= product._id %>" class="product_title_link">
                                      <h4 class="product_title"><%= product.name %></h4>
                                  </a>
                                  <% if (product.maxOffer && product.maxOffer > 0) { %>
                                      <div class="price-info">
                                          <span class="original-price"><del>MRP ₹<%= product.originalPrice.toFixed(2) %></del></span>
                                          <div class="discounted-price">MRP ₹<%= product.discountedPrice.toFixed(2) %></div>
                                      </div>
                                  <% } else { %>
                                      <div class="product_price">MRP ₹<%= product.price.toFixed(2) %></div>
                                  <% } %>
                                  <div class="product_actions">
                                      <button class="quick_add_btn" 
                                          onclick="addToCartAndRemoveFromWishlist('<%= product._id %>', 1, '<%= product.name %>', '<%= userId %>')">
                                          Add to Cart
                                      </button>
                                      <button class="wish_btn" onclick="addToWishlist('<%= product._id %>', event)">
                                          <i class="fa fa-heart-o"></i>
                                      </button>
                                  </div>
                              </div>
                          </div>
                      <% }); %>
                  <% } %>
              </div>
          </div>
      </div>
  </section>
    
    <!-- footer section -->
    <footer class="footer_section">
      <div class="container">
        <div class="row">
          <div class="col-md-4 footer-col">
            <div class="footer_contact">
              <h4>Contact Us</h4>
              <div class="contact_link_box">
                <a href="">
                  <i class="fa fa-map-marker" aria-hidden="true"></i>
                  <span> Location </span>
                </a>
                <a href="">
                  <i class="fa fa-phone" aria-hidden="true"></i>
                  <span> Call +91 8089113204 </span>
                </a>
                <a href="">
                  <i class="fa fa-envelope" aria-hidden="true"></i>
                  <span> mohddilshan1234321@gmail.com </span>
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-4 footer-col">
            <div class="footer_detail">
              <a href="" class="footer-logo"> SNACK STORM </a>
              <p>
                Necessary, making this the first true generator on the Internet.
                It uses a dictionary of over 200 Latin words, combined with
              </p>
              <div class="footer_social">
                <a href="">
                  <i class="fa fa-facebook" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-twitter" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-linkedin" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-instagram" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-pinterest" aria-hidden="true"></i>
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-4 footer-col">
            <h4>Opening Hours</h4>
            <p>Everyday</p>
            <p>10.00 Am -10.00 Pm</p>
          </div>
        </div>
        <div class="footer-info">
          <p>
            &copy; <span id="displayYear"></span> All Rights Reserved By
            <a href="">muhammed dilshihan</a><br /><br />
            &copy; <span id="displayYear"></span> Distributed By
            <a href="" target="_blank">dilshihan</a>
          </p>
        </div>
      </div>
    </footer>
    
    <!-- jQery -->
    <script src="/js/jquery-3.4.1.min.js"></script>
    <!-- popper js -->
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <!-- bootstrap js -->
    <script src="/js/bootstrap.js"></script>
    <!-- owl slider -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <!-- isotope js -->
    <script src="https://unpkg.com/isotope-layout@3.0.4/dist/isotope.pkgd.min.js"></script>
    <!-- nice select -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
    <!-- custom js -->
    <script src="/js/custom.js"></script>
    <!-- Google Map -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCh39n5U-4IoWpsVGUHWdqB6puEkhRLdmI&callback=myMap"></script>
    
    <script>
      let lastScrollTop = 0;
      const header = document.querySelector(".header_section");
      let headerHeight = header.offsetHeight;

      window.addEventListener(
        "scroll",
        function () {
          let currentScroll =
            window.pageYOffset || document.documentElement.scrollTop;

          if (currentScroll > lastScrollTop && currentScroll > headerHeight) {
            header.style.transform = "translateY(-100%)";
          } else {
            header.style.transform = "translateY(0)";
          }
          lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
        },
        false
      );
      
    </script>
    <script>
  async function addToWishlist(productId, event) { 
    try {
       
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }

        const response = await fetch('/user/add-to-wishlist', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ productId })
        });

        const data = await response.json();

        if (data.success) {
            const button = event ? event.target.closest('button') : document.querySelector(`button[data-product-id="${productId}"]`);
            
            if (button) {
                button.classList.remove('btn-outline-danger');
                button.classList.add('btn-danger');
                button.disabled = true;
                button.innerHTML = '<i class="fa fa-heart"></i> In Wishlist';
            }

            Swal.fire({
                icon: 'success',
                title: 'Added to Wishlist!',
                showConfirmButton: false,
                timer: 1500
            });
            setTimeout(()=>{
                      window.location.reload()
                    },1000)
        } else {
            Swal.fire({
                icon: 'error',
                title: 'Oops...',
                text: data.message || 'Something went wrong!'
            });
        }
    } catch (error) {
        console.error('Error:', error);
        Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: 'Something went wrong!'
        });
    }
}

function removeFromWishlist(productId) {
    Swal.fire({
        title: 'Are you sure?',
        text: "Do you want to remove this item from your wishlist?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it!',
        cancelButtonText: 'Cancel'
    }).then((result) => {
        if (result.isConfirmed) {
            fetch(`/user/wishlist/remove/${productId}`, {
                method: 'DELETE',
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const productElement = document.querySelector(`[data-product-id="${productId}"]`);
                    if (productElement) {
                        productElement.remove();
                    }
                    showToast('Success', 'Product removed from wishlist');
                    setTimeout(()=>{
                      window.location.reload()
                    },1000)
                } else {
                    showToast('Error', data.message || 'Failed to remove product');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error', 'Failed to remove product from wishlist');
            });
        }
    });
}

function showToast(type, message) {
    if (type.toLowerCase() === 'success') {
        Swal.fire({
            icon: 'success',
            title: 'Success',
            text: message,
            timer: 2000,
            showConfirmButton: false
        });
    } else {
        Swal.fire({
            icon: 'error',
            title: 'Error',
            text: message,
            timer: 2000,
            showConfirmButton: false
        });
    }
}

async function addToCartAndRemoveFromWishlist(productId, quantity = 1, productName, userId) {
    try {
        const response = await fetch("/user/add-to-cart", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ 
                userId, 
                productId, 
                quantity: quantity || 1
            }),
        });

        const data = await response.json();
        if (data.success) {
            try {
                const removeResponse = await fetch(`/user/wishlist/remove/${productId}`, {
                    method: 'DELETE',
                });
                const removeData = await removeResponse.json();
                
                if (removeData.success) {
                    const productElement = document.querySelector(`[data-product-id="${productId}"]`);
                    if (productElement) {
                        productElement.remove();
                    }
                }
            } catch (removeError) {
                console.error('Error removing from wishlist:', removeError);
            }

            Swal.fire({
                title: "Added to Cart!",
                text: `${productName} has been added successfully.`,
                icon: "success",
                showConfirmButton: false,
                timer: 1500
            });
            setTimeout(()=>{
                      window.location.reload()
                    },1000)
        } else {
            Swal.fire({
                title: "Error!",
                text: data.message,
                icon: "error",
                showConfirmButton: false,
                timer: 2000
            });
        }
    } catch (error) {
        console.error("Error:", error);
        Swal.fire({
            title: "Oops!",
            text: "Something went wrong. Please try again later.",
            icon: "error",
            showConfirmButton: false,
            timer: 2000
        });
    }
}
    </script>
 </body>
</html>