<!DOCTYPE html>
<html>
  <head>
    <!-- Basic -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <!-- Mobile Metas -->
    <meta
      name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/>
    <!-- Site Metas -->
    <meta name="keywords" content="" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <link rel="shortcut icon" href="/images/favicon.png" type="" />
    <title>SNACK STORM - Wallet</title>
    <link rel="stylesheet" type="text/css" href="/css/bootstrap.css" />
    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/assets/owl.carousel.min.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/css/nice-select.min.css" integrity="sha512-CruCP+TD3yXzlvvijET8wV5WxxEh5H8P4cmz0RFbKK6FlZ2sYl3AEsKlLPHbniXKSrDdFewhbmBK5skbdsASbQ==" crossorigin="anonymous"/>
    <link rel="stylesheet" type="text/css" href="/css/style.css" />
    <link rel="stylesheet" type="text/css" href="/css/responsive.css" />
    <link href="/css/font-awesome.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="/style/wallet.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  </head>
  <body class="sub_page">
    <header class="header_section">
      <div class="container">
        <nav class="navbar navbar-expand-lg custom_nav-container">
          <a class="navbar-brand" href="/user/home">
            <span> SNACK STORM </span>
          </a>

          <button
            class="navbar-toggler"
            type="button"
            data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent"
            aria-expanded="false"
            aria-label="Toggle navigation"
          >
            <span class=""> </span>
          </button>

          <div class="collapse navbar-collapse" id="navbarSupportedContent">
            <ul class="navbar-nav mx-auto">
              <li class="nav-item">
                <a class="nav-link" href="/user/home">Home </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/menu">Menu </a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/about">About</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="/user/contactus">Contact Us</a>
              </li>
            </ul>
            <div class="user_option">
              <a class="cart_link" href="/user/cart">
                <svg
                  version="1.1"
                  id="Capa_1"
                  xmlns="http://www.w3.org/2000/svg"
                  xmlns:xlink="http://www.w3.org/1999/xlink"
                  x="0px"
                  y="0px"
                  viewBox="0 0 456.029 456.029"
                  style="enable-background: new 0 0 456.029 456.029"
                  xml:space="preserve"
                >
                  <g>
                    <g>
                      <path
                        d="M345.6,338.862c-29.184,0-53.248,23.552-53.248,53.248c0,29.184,23.552,53.248,53.248,53.248
                     c29.184,0,53.248-23.552,53.248-53.248C398.336,362.926,374.784,338.862,345.6,338.862z"
                      />
                    </g>
                  </g>
                  <g>
                    <g>
                      <path
                        d="M439.296,84.91c-1.024,0-2.56-0.512-4.096-0.512H112.64l-5.12-34.304C104.448,27.566,84.992,10.67,61.952,10.67H20.48
                     C9.216,10.67,0,19.886,0,31.15c0,11.264,9.216,20.48,20.48,20.48h41.472c2.56,0,4.608,2.048,5.12,4.608l31.744,216.064
                     c4.096,27.136,27.648,47.616,55.296,47.616h212.992c26.624,0,49.664-18.944,55.296-45.056l33.28-166.4
                     C457.728,97.71,450.56,86.958,439.296,84.91z"
                      />
                    </g>
                  </g>
                  <g>
                    <g>
                      <path
                        d="M215.04,389.55c-1.024-28.16-24.576-50.688-52.736-50.688c-29.696,1.536-52.224,26.112-51.2,55.296
                     c1.024,28.16,24.064,50.688,52.224,50.688h1.024C193.536,443.31,216.576,418.734,215.04,389.55z"
                      />
                    </g>
                  </g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                  <g></g>
                </svg>
              </a>
              <form class="form-inline">
                <a href="/user/wishlist" class="btn my-2 my-sm-0 nav_wishlist-btn" style="color: white;">
                    <i class="fa fa-heart" aria-hidden="true"></i>
                </a>
              </form>
              <a href="/user/userprofile" class="user_link">
                <% if (user && user.image) { %>
                  <img src="<%= user.image %>" style="width: 30px; height: 30px; object-fit: cover; border-radius: 50%;" alt="Profile" />
                <% } else { %>
                  <i class="fa fa-user" aria-hidden="true"></i>
                <% } %>
              </a>
              </a>
            </div>
          </div>
        </nav>
      </div>
    </header>
    <div class="hero_area"></div>

    <!-- wallet section -->
    <section class="wallet_section layout_padding">
      <div class="container">
          <div class="wallet_header">
              <h2>My Wallet</h2>
          </div>
          
          <div class="row">
              <div class="col-12">
                  <div class="wallet_container">
                    <div class="wallet_balance">
                        <h3>Available Balance</h3>
                        <div class="balance_amount">₹<%= wallet.balance.toFixed(2) %></div>
                        <button class="add_money_btn" onclick="openAddMoneyModal()">
                            <i class="fa fa-plus-circle mr-2"></i> Add Money
                        </button>
                    </div>
                    
                    <div class="transaction_list">
                        <% if (wallet.transactions && wallet.transactions.length > 0) { %>
                            <% wallet.transactions.reverse().forEach(transaction => { %>
                                <div class="transaction_item <%= transaction.type %>">
                                    <div class="transaction_info">
                                        <div class="transaction_icon">
                                            <i class="fa fa-<%= transaction.type === 'credit' ? 'plus' : 'minus' %>"></i>
                                        </div>
                                        <div class="transaction_details">
                                            <h4>
                                                <%= transaction.type === 'credit' ? 
                                                    'Added Money to Wallet' : 
                                                    'Used in Order' %>
                                            </h4>
                                            <p><%= formatDate(transaction.timestamp) %></p>
                                        </div>
                                    </div>
                                    <div class="transaction_amount">
                                        <%= transaction.type === 'credit' ? '+' : '-' %>₹<%= Math.abs(transaction.amount).toFixed(2) %>
                                    </div>
                                </div>
                            <% }); %>
                        <% } else { %>
                            <div class="empty_transactions">
                                <i class="fa fa-exchange"></i>
                                <h3>No transactions yet</h3>
                                <p>Add money to your wallet to get started</p>
                                <button class="add_money_btn" onclick="openAddMoneyModal()">
                                    <i class="fa fa-plus-circle mr-2"></i> Add Money
                                </button>
                            </div>
                        <% } %>
                    </div>
                      
                    <div class="paginate">
                        <% if (pagination.hasPrev) { %>
                            <a href="?page=<%= pagination.currentPage - 1 %>"><button>&laquo;</button></a>
                        <% } else { %>
                            <button disabled>&laquo;</button>
                        <% } %>
                        
                        <% for(let i = 1; i <= pagination.totalPages; i++) { %>
                            <a href="?page=<%= i %>">
                                <button class="<%= pagination.currentPage === i ? 'active' : '' %>"><%= i %></button>
                            </a>
                        <% } %>
                        
                        <% if (pagination.hasNext) { %>
                            <a href="?page=<%= pagination.currentPage + 1 %>"><button>&raquo;</button></a>
                        <% } else { %>
                            <button disabled>&raquo;</button>
                        <% } %>
                    </div>
                      
                      <!-- Empty state (hidden by default) -->
                      <div class="empty_transactions" style="display: none;">
                          <i class="fa fa-exchange"></i>
                          <h3>No transactions yet</h3>
                          <p>Add money to your wallet to get started</p>
                          <button class="add_money_btn" onclick="openAddMoneyModal()">
                              <i class="fa fa-plus-circle mr-2"></i> Add Money
                          </button>
                      </div>
                  </div>
              </div>
          </div>
      </div>
      
      <!-- Add Money Modal -->
      <div id="addMoneyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeAddMoneyModal()">&times;</span>
            <div class="modal-header">
                <h3>Add Money to Wallet</h3>
            </div>
            <div class="amount-input-group">
                <label for="amount">Enter Amount</label>
                <div class="amount-input">
                    <span>₹</span>
                    <input type="number" id="amount" placeholder="Enter amount" min="1">
                </div>
            </div>
            <div class="preset-amounts">
                <button type="button" class="preset-amount" onclick="setAmount(100)">₹100</button>
                <button type="button" class="preset-amount" onclick="setAmount(200)">₹200</button>
                <button type="button" class="preset-amount" onclick="setAmount(500)">₹500</button>
                <button type="button" class="preset-amount" onclick="setAmount(1000)">₹1000</button>
            </div>
            <div class="add-money-action">
                <button type="button" onclick="addMoney()">Proceed to Add</button>
            </div>
        </div>
    </div>
  </section>
    
    <!-- footer section -->
    <footer class="footer_section">
      <div class="container">
        <div class="row">
          <div class="col-md-4 footer-col">
            <div class="footer_contact">
              <h4>Contact Us</h4>
              <div class="contact_link_box">
                <a href="">
                  <i class="fa fa-map-marker" aria-hidden="true"></i>
                  <span> Location </span>
                </a>
                <a href="">
                  <i class="fa fa-phone" aria-hidden="true"></i>
                  <span> Call +91 8089113204 </span>
                </a>
                <a href="">
                  <i class="fa fa-envelope" aria-hidden="true"></i>
                  <span> mohddilshan1234321@gmail.com </span>
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-4 footer-col">
            <div class="footer_detail">
              <a href="" class="footer-logo"> SNACK STORM </a>
              <p>
                Necessary, making this the first true generator on the Internet.
                It uses a dictionary of over 200 Latin words, combined with
              </p>
              <div class="footer_social">
                <a href="">
                  <i class="fa fa-facebook" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-twitter" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-linkedin" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-instagram" aria-hidden="true"></i>
                </a>
                <a href="">
                  <i class="fa fa-pinterest" aria-hidden="true"></i>
                </a>
              </div>
            </div>
          </div>
          <div class="col-md-4 footer-col">
            <h4>Opening Hours</h4>
            <p>Everyday</p>
            <p>10.00 Am -10.00 Pm</p>
          </div>
        </div>
        <div class="footer-info">
          <p>
            &copy; <span id="displayYear"></span> All Rights Reserved By
            <a href="">muhammed dilshihan</a><br /><br />
            &copy; <span id="displayYear"></span> Distributed By
            <a href="" target="_blank">dilshihan</a>
          </p>
        </div>
      </div>
    </footer>
    
    <!-- jQery -->
    <script src="/js/jquery-3.4.1.min.js"></script>
    <!-- popper js -->
    <script
      src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js"
      integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo"
      crossorigin="anonymous"
    ></script>
    <!-- bootstrap js -->
    <script src="/js/bootstrap.js"></script>
    <!-- owl slider -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/OwlCarousel2/2.3.4/owl.carousel.min.js"></script>
    <!-- isotope js -->
    <script src="https://unpkg.com/isotope-layout@3.0.4/dist/isotope.pkgd.min.js"></script>
    <!-- nice select -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-nice-select/1.1.0/js/jquery.nice-select.min.js"></script>
    <!-- custom js -->
    <script src="/js/custom.js"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <script>
      let lastScrollTop = 0;
      const header = document.querySelector(".header_section");
      let headerHeight = header.offsetHeight;

      window.addEventListener(
        "scroll",
        function () {
          let currentScroll =
            window.pageYOffset || document.documentElement.scrollTop;

          if (currentScroll > lastScrollTop && currentScroll > headerHeight) {
            header.style.transform = "translateY(-100%)";
          } else {
            header.style.transform = "translateY(0)";
          }
          lastScrollTop = currentScroll <= 0 ? 0 : currentScroll;
        },
        false
      );
      
      async function addMoney() {
    try {
        const amount = document.getElementById('amount').value;
        
        if (!amount || amount <= 0) {
            Swal.fire({
                icon: 'warning',
                title: 'Invalid Amount',
                text: 'Please enter a valid amount'
            });
            return;
        }
        if (amount > 10000) {
            Swal.fire({
                icon: 'warning',
                title: 'Amount Exceeds Limit',
                text: 'Maximum amount allowed is ₹10,000'
            });
            return;
        }

        const options = {
            key:'rzp_test_M7FP669jy9r82N',
            amount: amount * 100, 
            currency: 'INR',
            name: 'SNACK STORM ',
            description: 'Add Money to Wallet',
            handler: async function (response) {
                const paymentData = {
                    amount: parseFloat(amount),
                    razorpay_payment_id: response.razorpay_payment_id,
                    razorpay_order_id: response.razorpay_order_id,
                    razorpay_signature: response.razorpay_signature
                };

                const serverResponse = await fetch('add-money', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(paymentData)
                });

                const data = await serverResponse.json();
                
                if (data.success) {
                    Swal.fire({
                        icon: 'success',
                        title: 'Success!',
                        text: 'Money added successfully!'
                    }).then(() => {
                        location.reload();
                    });
                    closeAddMoneyModal();
                } else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.message || 'Failed to add money'
                    });
                }
            },
            prefill: {
                name: '', 
                email: '',
                contact: ''
            },
            theme: {
                color: '#3399cc'
            }
        };
        const rzp = new Razorpay(options);
        rzp.open();

    }  catch (error) {
        console.error('Error adding money:', error);
        let errorMessage = 'Failed to add money to wallet';
        if (error instanceof RazorpayError) {
            errorMessage = 'Payment gateway error: ' + error.message;
        } else if (error.name === 'NetworkError') {
            errorMessage = 'Network error: Please check your internet connection';
        } else if (error.response) {
            errorMessage = `Server error: ${error.response.data?.message || 'Unknown server error'}`;
        }

        Swal.fire({
            icon: 'error',
            title: 'Payment Error',
            text: errorMessage,
            footer: 'Please try again or contact support if the issue persists'
        });
    }
}

function openAddMoneyModal() {
    const modal = document.getElementById('addMoneyModal');
    modal.style.display = 'block';
    document.getElementById('amount').value = '';
    const buttons = document.querySelectorAll('.preset-amount');
    buttons.forEach(button => button.classList.remove('active'));
}

function closeAddMoneyModal() {
    const modal = document.getElementById('addMoneyModal');
    modal.style.display = 'none';
}

function setAmount(amount) {
    document.getElementById('amount').value = amount;
    const buttons = document.querySelectorAll('.preset-amount');
    buttons.forEach(button => button.classList.remove('active'));
    event.target.classList.add('active');
}

window.onclick = function(event) {
    const modal = document.getElementById('addMoneyModal');
    if (event.target == modal) {
        closeAddMoneyModal();
    }
}
    </script>
 </body>
</html>